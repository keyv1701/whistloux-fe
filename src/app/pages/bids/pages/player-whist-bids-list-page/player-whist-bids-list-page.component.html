<div class="container mt-4">
  <h1 class="text-center mb-4">Liste des annonces par joueur</h1>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form [formGroup]="filterForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Saison {{ filterForm.get('season')?.value }}</label>
            <div class="search-container">
              <div class="input-group search-input">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Rechercher un joueur..."
                  formControlName="search"
                  (input)="applyFilters()">
              </div>
              <div *ngIf="filterForm.get('search')?.value && filteredPlayerBids.length > 0"
                   class="search-results-count">
                {{ filteredPlayerBids.length }} joueur(s) trouvé(s)
              </div>
            </div>
          </div>
          <div class="col-md-6 d-flex justify-content-end">
            <button class="btn btn-success me-2" (click)="exportToExcel()" [disabled]="loading">
              <i class="bi bi-file-earmark-excel me-2"></i>Exporter la saison
            </button>
            <button class="btn btn-primary" (click)="openImportDialog()" [disabled]="loading">
              <i class="bi bi-upload me-2"></i>Importer
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div *ngIf="loading" class="d-flex justify-content-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger shadow-sm" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
  </div>

  <div *ngIf="!loading && filteredPlayerBids.length === 0" class="alert alert-info shadow-sm" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>Aucune enchère trouvée pour cette recherche.
  </div>

  <div *ngIf="filteredPlayerBids.length > 0" class="table-responsive card shadow-sm">
    <table class="table table-striped table-hover mb-0">
      <thead>
      <tr class="table-primary">
        <th class="text-nowrap sticky-col sortable"
            [class.sort-asc]="sortColumn === 'playerName' && sortDirection === 'asc'"
            [class.sort-desc]="sortColumn === 'playerName' && sortDirection === 'desc'"
            (click)="sortBy('playerName')">
          Joueur
        </th>
        <th class="text-nowrap text-center sortable"
            [class.sort-asc]="sortColumn === 'totalBids' && sortDirection === 'asc'"
            [class.sort-desc]="sortColumn === 'totalBids' && sortDirection === 'desc'"
            (click)="sortBy('totalBids')">
          Total
        </th>
        <th class="text-nowrap text-center">Petit Misère</th>
        <th class="text-nowrap text-center">Picolissimo</th>
        <th class="text-nowrap text-center">Huitième</th>
        <th class="text-nowrap text-center">Petit Misère Entame</th>
        <th class="text-nowrap text-center">Abondance 9</th>
        <th class="text-nowrap text-center">Grand Misère</th>
        <th class="text-nowrap text-center">Abondance 10</th>
        <th class="text-nowrap text-center">Abondance 11</th>
        <th class="text-nowrap text-center">Grand Misère Entame</th>
        <th class="text-nowrap text-center">Grand Misère Ouvert</th>
        <th class="text-nowrap text-center">Petit Chelem</th>
        <th class="text-nowrap text-center">Grand Chelem</th>
      </tr>
      <tr class="table-secondary">
        <th class="text-nowrap sticky-col">Points</th>
        <th></th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.PM] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.PIC] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.H8] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.PME] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.AB9] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.GM] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.AB10] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.AB11] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.GME] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.GMO] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.PCH] }}</th>
        <th class="text-center fw-bold bid-points">{{ WhistBidPoints[WhistBid.GCH] }}</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let playerBid of paginatedPlayerBids">
        <td class="fw-bold sticky-col">{{ playerBid.playerFirstname }} {{ playerBid.playerLastName }}</td>
        <td class="text-center fw-bold">{{ getTotalBids(playerBid) }}</td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.PM) > 0}">{{ getBidTypeCount(playerBid, WhistBid.PM) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.PIC) > 0}">{{ getBidTypeCount(playerBid, WhistBid.PIC) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.H8) > 0}">{{ getBidTypeCount(playerBid, WhistBid.H8) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.PME) > 0}">{{ getBidTypeCount(playerBid, WhistBid.PME) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.AB9) > 0}">{{ getBidTypeCount(playerBid, WhistBid.AB9) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.GM) > 0}">{{ getBidTypeCount(playerBid, WhistBid.GM) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.AB10) > 0}">{{ getBidTypeCount(playerBid, WhistBid.AB10) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.AB11) > 0}">{{ getBidTypeCount(playerBid, WhistBid.AB11) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.GME) > 0}">{{ getBidTypeCount(playerBid, WhistBid.GME) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.GMO) > 0}">{{ getBidTypeCount(playerBid, WhistBid.GMO) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.PCH) > 0}">{{ getBidTypeCount(playerBid, WhistBid.PCH) }}
        </td>
        <td class="text-center bid-cell"
            [ngClass]="{'has-bids': getBidTypeCount(playerBid, WhistBid.GCH) > 0}">{{ getBidTypeCount(playerBid, WhistBid.GCH) }}
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-3" *ngIf="filteredPlayerBids.length > pageSize">
    <nav>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">
            <i class="bi bi-chevron-left"></i>
          </a>
        </li>
        <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
          <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">
            <i class="bi bi-chevron-right"></i>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<app-import-modal
  [isOpen]="showImportDialog"
  [title]="'Importer des enchères'"
  [acceptTypes]="'.xlsx'"
  [description]="'Sélectionnez un fichier Excel (.xlsx) contenant les données d\'enchères à importer.'"
  (fileSelected)="importData($event)"
  (closeModal)="closeImportDialog()"
></app-import-modal>
